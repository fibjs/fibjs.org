# 找出性能杀手

在线服务的性能优化常常被视为一种近乎迷信的工作。一群程序员面对着大量晦涩难懂的代码，互相猜测是否是对方耗尽了 CPU 资源。为了找出性能瓶颈，他们花费大量时间记录日志，并在海量的日志中日以继夜地翻看。然而，使用 fibjs，这一切都将变得简单起来。因为 fibjs 提供了强大的 CPU 和内存 profiler 支持，而且使用十分方便。

在现代软件开发中，性能优化是一个不可忽视的重要环节。无论是小型应用还是大型分布式系统，性能问题都会直接影响用户体验和系统的稳定性。传统的性能优化方法通常依赖于开发者的经验和直觉，这不仅耗时耗力，而且往往难以找到真正的性能瓶颈。为了更高效地进行性能优化，我们需要借助专业的工具来进行精确的性能分析。

fibjs 是一个高性能的 JavaScript 引擎，专为服务器端应用设计。它不仅提供了丰富的功能库，还内置了强大的性能分析工具。通过使用 fibjs 的 CPU 和内存 profiler，我们可以轻松地捕捉应用程序的性能数据，并生成详细的分析报告。这些报告以火焰图的形式展示，直观地显示了应用程序中各个函数的 CPU 使用情况，从而帮助我们快速定位性能瓶颈。

## 记录日志

启动 fibjs 的 CPU profiler 极其简单，只需在启动时增加 `--prof` 选项即可。默认的日志记录间隔是 1000ms，但随着优化的深入，你可能需要更高精度的分析日志，此时可以使用 `--prof-interval` 选项来设置间隔。以下示例展示了如何每 10ms 记录一次 fibjs 的工作日志：

```sh
fibjs --prof --prof-interval=10 main.js
```

### 日志记录间隔

日志记录间隔是指 profiler 记录 CPU 使用情况的时间间隔。默认情况下，fibjs 每隔 1000ms 记录一次日志，这对于大多数应用来说已经足够。然而，在某些情况下，你可能需要更高的精度来捕捉短时间内的性能波动。通过设置 `--prof-interval` 选项，你可以调整日志记录的频率。例如，设置为 10ms 可以更精细地捕捉 CPU 使用情况，但也会生成更多的日志数据。

## 处理日志

当程序正常结束或使用 `Ctrl+C` 终止进程后，当前目录下会生成一个日志文件，文件名类似于 `fibjs-xxxx.log`。此时，你可以使用 `--prof-process` 选项来处理生成的日志：

```sh
fibjs --prof-process fibjs-xxxx.log prof.svg
```

处理完成后，你可以使用浏览器打开 `prof.svg` 文件，以查看此次日志的火焰图：

![prof](./imgs/prof.svg)

你可以点击查看全尺寸的图片。在全尺寸图片中，你可以通过鼠标操作，查阅更详细的信息：[prof.svg](./imgs/prof.svg)。

### 日志文件命名

生成的日志文件名通常包含时间戳或其他唯一标识符，以确保每次运行生成的日志文件不会被覆盖。这使得你可以在不同时间点运行 profiler，并对比不同时间段的性能数据。

## 火焰图解读

火焰图是分析和优化性能的强大工具。通过火焰图，你可以直观地看到应用程序中哪些部分消耗了最多的 CPU 时间，从而帮助你找到性能瓶颈并进行优化。

### 色块的含义

火焰图中的每一个色块代表一个记录点，色块越长，表示该函数在采样期间被记录的次数越多。每一行代表一层调用堆栈，层数越多表示调用的层数越多。调用堆栈的摆放是倒置的，越靠下的色块，越是最初的函数。

### 色块的颜色

在 fibjs 的 profiler 中，色块的颜色分为两类：
- **红色**：代表 JavaScript 运算，通常是 CPU 密集型操作。
- **蓝色**：代表 IO 操作或者 Native 运算，通常是等待外部资源的操作，例如文件读写、数据库操作、网络操作等。

### 分析重点

根据你需要解决的问题不同，所需关注的区域也会不同：
- **CPU 占用过高**：关注红色的色块，这些色块表示 JavaScript 运算，通常是 CPU 密集型操作。
- **响应速度慢**：关注蓝色的色块，这些色块表示 IO 操作或 Native 运算，通常是等待外部资源的操作。

### 色块的长度

色块的长度表示该函数在采样期间被记录的次数。色块越长，表示该函数占用的 CPU 时间越多。通过观察色块的长度，可以直观地判断哪些函数是性能瓶颈。

### 调用堆栈

火焰图的每一层代表一个函数调用堆栈，最底层是最初的函数调用，越往上是越深的调用。通过分析火焰图，你可以直观地看到哪些函数调用占用了最多的 CPU 时间。

### 重点关注区域

靠近顶部的较大色块，通常是需要重点关注和优化的部分。这些色块代表了在采样期间占用大量 CPU 时间的函数。通过优化这些函数，可以显著提升应用的性能。

### 实际案例分析

假设你有一个在线服务，用户反馈该服务在高峰期响应速度变慢。你怀疑是某些代码段导致了性能瓶颈，于是决定使用 fibjs 的 profiler 进行分析。

首先，启动服务并开启 profiler：

```sh
fibjs --prof --prof-interval=10 server.js
```

在高峰期运行一段时间后，使用 `Ctrl+C` 终止进程，生成日志文件 `fibjs-xxxx.log`。接着，处理日志文件生成火焰图：

```sh
fibjs --prof-process fibjs-xxxx.log prof.svg
```

打开 `prof.svg` 文件，查看火焰图。你发现有一大片红色色块集中在某个函数调用上，这表明该函数占用了大量的 CPU 资源。进一步分析代码，你发现该函数中存在一个低效的算法。优化算法后，重新部署服务并再次使用 profiler 进行测试，发现火焰图中的红色色块明显减少，服务响应速度显著提升。

通过这种方式，你可以轻松找到性能瓶颈，并进行针对性的优化。无论是 CPU 占用过高还是响应速度慢，profiler 都能帮助你快速定位问题所在，从而提升在线服务的性能。

## 结论

通过使用 fibjs 的 profiler，你可以轻松找到性能瓶颈，并进行针对性的优化。无论是 CPU 占用过高还是响应速度慢，profiler 都能帮助你快速定位问题所在，从而提升在线服务的性能。

👉 【[同步和异步](sync.md)】